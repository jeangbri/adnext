"use strict";(()=>{var e={};e.id=66,e.ids=[66],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},79171:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>k,originalPathname:()=>_,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>b});var a={};t.r(a),t.d(a,{GET:()=>u,dynamic:()=>g,runtime:()=>l});var s=t(22534),o=t(79409),n=t(36717),c=t(27445),i=t(38588),p=t(59609);let l="nodejs",g="force-dynamic";async function u(e){let r=e.nextUrl.searchParams,t=r.get("code"),a=r.get("state");if(r.get("error")||!t||!a)return c.Z.redirect(new URL("/settings/integracoes?error=access_denied",e.url));try{let{workspaceId:r}=JSON.parse((0,p.p)(a)),s=process.env.FB_APP_ID,o=process.env.FB_APP_SECRET,n=process.env.APP_URL||(process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000"),l=`${n}/api/messenger/callback`,g=new URL("https://graph.facebook.com/v19.0/oauth/access_token");g.searchParams.append("client_id",s),g.searchParams.append("client_secret",o),g.searchParams.append("redirect_uri",l),g.searchParams.append("code",t);let u=await fetch(g.toString()),d=await u.json();if(!u.ok)throw Error(d.error?.message||"Failed to exchange token");let m=d.access_token,f=[],h=`https://graph.facebook.com/v19.0/me/accounts?access_token=${m}&limit=100`;for(;;){let e=await fetch(h),r=await e.json();if(!e.ok)throw Error(r.error?.message||"Failed to fetch pages");let t=r.data||[];if(f=[...f,...t],r.paging?.next)h=r.paging.next;else break}let k=f,b=0;for(let e of k){let t=(0,p.H)(e.access_token);await i._.messengerPage.upsert({where:{pageId:e.id},update:{workspaceId:r,pageName:e.name,pageAccessToken:t,isActive:!0,updatedAt:new Date},create:{workspaceId:r,pageId:e.id,pageName:e.name,pageAccessToken:t,isActive:!0}});try{let r=`https://graph.facebook.com/v19.0/${e.id}/subscribed_apps?access_token=${e.access_token}`,t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscribed_fields:["messages","messaging_postbacks","messaging_optins","message_deliveries","message_reads","feed"]})});if(t.ok)console.log(`[Messenger Callback] Subscribed app to page ${e.name}`);else{let r=await t.json();console.error(`[Messenger Callback] Failed to subscribe page ${e.name}:`,r)}}catch(e){console.error("[Messenger Callback] Subscription network error:",e)}b++}return c.Z.redirect(new URL("/settings/integracoes?success=true&count="+b,e.url))}catch(r){return console.error("[Messenger Callback] Error:",r),c.Z.redirect(new URL("/settings/integracoes?error=server_error",e.url))}}let d=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/messenger/callback/route",pathname:"/api/messenger/callback",filename:"route",bundlePath:"app/api/messenger/callback/route"},resolvedPagePath:"C:\\Users\\jeang\\OneDrive\\Desktop\\adnext\\apps\\web\\src\\app\\api\\messenger\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:k,staticGenerationBailout:b}=d,_="/api/messenger/callback/route";function v(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},59609:(e,r,t)=>{t.d(r,{H:()=>c,p:()=>i});var a=t(6113),s=t.n(a);let o="aes-256-cbc",n=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function c(e){let r=s().randomBytes(16),t=s().createCipheriv(o,Buffer.from(n),r),a=t.update(e);return a=Buffer.concat([a,t.final()]),r.toString("hex")+":"+a.toString("hex")}function i(e){let r=e.split(":"),t=Buffer.from(r.shift(),"hex"),a=Buffer.from(r.join(":"),"hex"),c=s().createDecipheriv(o,Buffer.from(n),t),i=c.update(a);return(i=Buffer.concat([i,c.final()])).toString()}},38588:(e,r,t)=>{t.d(r,{_:()=>s});var a=t(53524);let s=globalThis.prisma??new a.PrismaClient({log:["error","warn"]})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[150,363],()=>t(79171));module.exports=a})();