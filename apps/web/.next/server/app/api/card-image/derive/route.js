"use strict";(()=>{var e={};e.id=7359,e.ids=[7359],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},15626:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>I,originalPathname:()=>S,patchFetch:()=>A,requestAsyncStorage:()=>y,routeModule:()=>b,serverHooks:()=>k,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>R});var a={};r.r(a),r.d(a,{POST:()=>j,PUT:()=>w,runtime:()=>v});var i=r(22534),o=r(79409),s=r(36717),n=r(27445),u=r(79938),d=r(61242);let l=require("sharp");var c=r.n(l);let h={SQUARE:{label:"Quadrado (1:1)",ratio:1,cssAspectRatio:"1 / 1",idealWidth:1080,idealHeight:1080,idealLabel:"1080\xd71080",messengerRatio:"square",deriveStrategy:"crop"},PORTRAIT:{label:"Retrato (4:5)",ratio:.8,cssAspectRatio:"4 / 5",idealWidth:1080,idealHeight:1350,idealLabel:"1080\xd71350",messengerRatio:"square",deriveStrategy:"fit"},LANDSCAPE:{label:"Paisagem (1.91:1)",ratio:1.91,cssAspectRatio:"1.91 / 1",idealWidth:1200,idealHeight:628,idealLabel:"1200\xd7628",messengerRatio:"horizontal",deriveStrategy:"crop"}};async function g(e,t){let r=h[t]||h.SQUARE;return"fit"===r.deriveStrategy?f(e,r):p(e,r)}async function p(e,t){let r,a;let i=t.idealWidth,o=t.idealHeight,s=await c()(e).metadata(),n=s.width||i,u=s.height||o,d=i/o;n/u>d?(a=u,r=Math.round(u*d)):(r=n,a=Math.round(n/d));let l=Math.round((n-r)/2),h=Math.round((u-a)/2);return{buffer:(await c()(e).extract({left:l,top:h,width:r,height:a}).resize(i,o,{fit:"fill",kernel:c().kernel.lanczos3}).jpeg({quality:90,mozjpeg:!0}).toBuffer({resolveWithObject:!0})).data,width:i,height:o,format:"jpeg"}}async function f(e,t){let r=await c()(e).resize(1080,1080,{fit:"inside",withoutEnlargement:!1,kernel:c().kernel.lanczos3}).toBuffer({resolveWithObject:!0}),a=r.info.width,i=r.info.height;return{buffer:(await c()({create:{width:1080,height:1080,channels:3,background:{r:255,g:255,b:255}}}).composite([{input:r.data,left:Math.round((1080-a)/2),top:Math.round((1080-i)/2)}]).jpeg({quality:90,mozjpeg:!0}).toBuffer({resolveWithObject:!0})).data,width:1080,height:1080,format:"jpeg"}}async function m(e){let t=await c()(e).metadata();return{width:t.width||0,height:t.height||0}}let v="nodejs";async function j(e){let t=(0,d.e)(),{data:{user:r}}=await t.auth.getUser();if(!r)return n.Z.json({error:"Unauthorized"},{status:401});try{let{imageUrl:t,cardFormat:r}=await e.json();if(!t)return n.Z.json({error:"imageUrl is required"},{status:400});if(!["SQUARE","PORTRAIT","LANDSCAPE"].includes(r))return n.Z.json({error:"Invalid cardFormat"},{status:400});let a=await fetch(t);if(!a.ok)return n.Z.json({error:`Failed to fetch image: ${a.status}`},{status:400});let i=await a.arrayBuffer(),o=Buffer.from(i),s=await g(o,r),d="https://fmxdqpukjuzhiseyobvz.supabase.co",l=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!d||!l)return n.Z.json({error:"Server configuration error: Missing Supabase keys"},{status:500});let c=(0,u.eI)(d,l),h=`derived_${r.toLowerCase()}_${Date.now()}_${Math.random().toString(36).substring(2,8)}.jpg`,p=`uploads/derived/${h}`,{error:f}=await c.storage.from("media").upload(p,s.buffer,{contentType:"image/jpeg",cacheControl:"31536000",upsert:!1});if(f)return console.error("Derived upload error:",f),n.Z.json({error:f.message},{status:500});let{data:{publicUrl:m}}=c.storage.from("media").getPublicUrl(p);return n.Z.json({derivedUrl:m,width:s.width,height:s.height})}catch(e){return console.error("Card image derive error:",e),n.Z.json({error:e.message},{status:500})}}async function w(e){let t=(0,d.e)(),{data:{user:r}}=await t.auth.getUser();if(!r)return n.Z.json({error:"Unauthorized"},{status:401});try{let{imageUrl:t}=await e.json();if(!t)return n.Z.json({error:"imageUrl is required"},{status:400});let r=await fetch(t);if(!r.ok)return n.Z.json({error:`Failed to fetch image: ${r.status}`},{status:400});let a=await r.arrayBuffer(),i=Buffer.from(a),o=await m(i);return n.Z.json(o)}catch(e){return console.error("Image dimensions error:",e),n.Z.json({error:e.message},{status:500})}}let b=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/card-image/derive/route",pathname:"/api/card-image/derive",filename:"route",bundlePath:"app/api/card-image/derive/route"},resolvedPagePath:"C:\\Users\\jeang\\OneDrive\\Desktop\\adnext\\apps\\web\\src\\app\\api\\card-image\\derive\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:k,headerHooks:I,staticGenerationBailout:R}=b,S="/api/card-image/derive/route";function A(){return(0,s.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:x})}},61242:(e,t,r)=>{r.d(t,{e:()=>o});var a=r(51441),i=r(97705);function o(){let e=(0,i.cookies)(),t="https://fmxdqpukjuzhiseyobvz.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZteGRxcHVranV6aGlzZXlvYnZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2Mjk4MjYsImV4cCI6MjA4NTIwNTgyNn0.bXEJnoTUSzAVDwQNwwiG1gmFc0rfK5M9xbKFMRb48BY";return t&&r||(console.warn("⚠️ Missing Supabase environment variables. Using fallback for build."),"build"!==process.env.npm_lifecycle_event&&t)?(0,a.lx)(t||"",r||"",{cookies:{get:t=>e.get(t)?.value,set(t,r,a){try{e.set({name:t,value:r,...a})}catch(e){}},remove(t,r){try{e.set({name:t,value:"",...r})}catch(e){}}}}):(0,a.lx)(t||"https://placeholder.supabase.co",r||"placeholder",{cookies:{get:()=>void 0,set:()=>{},remove:()=>{}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[2150,6363,3422],()=>r(15626));module.exports=a})();