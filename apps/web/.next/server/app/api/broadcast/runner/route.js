"use strict";(()=>{var e={};e.id=675,e.ids=[675],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},16571:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>f,originalPathname:()=>I,patchFetch:()=>T,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>E});var r={};a.r(r),a.d(r,{GET:()=>g,dynamic:()=>u,runtime:()=>p});var i=a(22534),s=a(79409),n=a(36717),o=a(27445),d=a(38588),c=a(59609);let p="nodejs",u="force-dynamic";async function g(e){let t=e.nextUrl.searchParams.get("key"),a=e.headers.get("authorization"),r=t===process.env.RUNNER_SECRET,i=process.env.CRON_SECRET&&a===`Bearer ${process.env.CRON_SECRET}`;if(!r&&!i)return o.Z.json({error:"Unauthorized"},{status:401});let s=new Date,n=await d._.broadcastCampaign.findMany({where:{OR:[{status:"SCHEDULED",scheduledAt:{lte:s}},{status:"SENDING"}]},take:5,include:{page:!0}});if(0===n.length)return o.Z.json({processed:0,status:"idle"});let p=0;for(let e of n)try{if("SCHEDULED"===e.status){console.log(`[Runner] Generating audience for campaign ${e.id}`);let t={workspaceId:e.workspaceId,pageId:e.pageId},a=new Date(s.getFullYear(),s.getMonth(),s.getDate());"ACTIVE_24H"===e.audienceType?t.lastMessageAt={gte:new Date(s.getTime()-864e5)}:"ACTIVE_7D"===e.audienceType?t.lastMessageAt={gte:new Date(s.getTime()-6048e5)}:"NEW_TODAY"===e.audienceType&&(t.firstSeenAt={gte:a});let r=await d._.contact.findMany({where:t,select:{id:!0,psid:!0}});r.length>0&&await d._.broadcastRecipient.createMany({data:r.map(t=>({campaignId:e.id,workspaceId:e.workspaceId,pageId:e.pageId,userPsid:t.psid,contactId:t.id,status:"PENDING"})),skipDuplicates:!0}),await d._.broadcastCampaign.update({where:{id:e.id},data:{status:"SENDING",totalRecipients:r.length}})}let t=await d._.broadcastRecipient.findMany({where:{campaignId:e.id,status:"PENDING"},take:50});if(0===t.length){let t=await d._.broadcastRecipient.count({where:{campaignId:e.id,status:"PENDING"}});if(0===t){await d._.broadcastCampaign.update({where:{id:e.id},data:{status:"COMPLETED"}});let t=await d._.broadcastRecipient.count({where:{campaignId:e.id,status:"SENT"}}),a=await d._.broadcastRecipient.count({where:{campaignId:e.id,status:"FAILED"}}),r=await d._.broadcastRecipient.count({where:{campaignId:e.id,status:"SKIPPED"}});await d._.broadcastCampaign.update({where:{id:e.id},data:{totalSent:t,totalFailed:a,totalSkipped:r}})}continue}let a=(0,c.p)(e.page.pageAccessToken);for(let r of t){var u;let t,i=!1,s=null,n="RESPONSE",o=await d._.contact.findUnique({where:{id:r.contactId}});if(!o){await d._.broadcastRecipient.update({where:{id:r.id},data:{status:"FAILED",error:"Contact not found"}});continue}let c=(u=o.lastSeenAt,new Date().getTime()-u.getTime()<=864e5);if("24H_ONLY"===e.policyMode?c?i=!0:(i=!1,s="OUTSIDE_24H"):c?i=!0:e.tag?(i=!0,n="MESSAGE_TAG",t=e.tag):(i=!1,s="OUTSIDE_24H_NO_TAG"),!i){await d._.broadcastRecipient.update({where:{id:r.id},data:{status:"SKIPPED",skipReason:s}});continue}try{let i={recipient:{id:r.userPsid},messaging_type:n,tag:t},s=e.payload;"TEXT"===e.messageType?i.message={text:s.text}:"BUTTON_TEMPLATE"===e.messageType?i.message={attachment:{type:"template",payload:{template_type:"button",text:s.text,buttons:s.buttons}}}:"AUDIO"===e.messageType&&(i.message={attachment:{type:"audio",payload:{url:s.url}}});let c=`https://graph.facebook.com/v19.0/me/messages?access_token=${a}`,u=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),g=await u.json();u.ok?(await d._.broadcastRecipient.update({where:{id:r.id},data:{status:"SENT",sentAt:new Date,metaMessageId:g.message_id}}),await d._.messageLog.create({data:{pageId:e.pageId,contactId:o.id,campaignId:e.id,direction:"OUT",status:"SENT",actionType:"BROADCAST",rawResponse:g}}),p++):(await d._.broadcastRecipient.update({where:{id:r.id},data:{status:"FAILED",error:g.error?.message||"Unknown graph error"}}),await d._.messageLog.create({data:{pageId:e.pageId,contactId:o.id,campaignId:e.id,direction:"OUT",status:"FAILED",actionType:"BROADCAST",error:g.error?.message}}))}catch(e){await d._.broadcastRecipient.update({where:{id:r.id},data:{status:"FAILED",error:e.message}})}}let r=await d._.broadcastRecipient.count({where:{campaignId:e.id,status:"SENT"}});await d._.broadcastCampaign.update({where:{id:e.id},data:{totalSent:r}})}catch(t){console.error(`[Runner] Error processing campaign ${e.id}`,t)}return o.Z.json({processed:p,status:"ok"})}let l=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/broadcast/runner/route",pathname:"/api/broadcast/runner",filename:"route",bundlePath:"app/api/broadcast/runner/route"},resolvedPagePath:"C:\\Users\\jeang\\OneDrive\\Desktop\\adnext\\apps\\web\\src\\app\\api\\broadcast\\runner\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:h,headerHooks:f,staticGenerationBailout:E}=l,I="/api/broadcast/runner/route";function T(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},59609:(e,t,a)=>{a.d(t,{H:()=>o,p:()=>d});var r=a(6113),i=a.n(r);let s="aes-256-cbc",n=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function o(e){let t=i().randomBytes(16),a=i().createCipheriv(s,Buffer.from(n),t),r=a.update(e);return r=Buffer.concat([r,a.final()]),t.toString("hex")+":"+r.toString("hex")}function d(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),r=Buffer.from(t.join(":"),"hex"),o=i().createDecipheriv(s,Buffer.from(n),a),d=o.update(r);return(d=Buffer.concat([d,o.final()])).toString()}},38588:(e,t,a)=>{a.d(t,{_:()=>i});var r=a(53524);let i=globalThis.prisma??new r.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[150,363],()=>a(16571));module.exports=r})();