"use strict";(()=>{var e={};e.id=9675,e.ids=[9675,8375],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},16571:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>E,patchFetch:()=>I,requestAsyncStorage:()=>l,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var r={};a.r(r),a.d(r,{GET:()=>u,dynamic:()=>p,runtime:()=>c});var i=a(22534),s=a(79409),n=a(36717),o=a(27445),d=a(38375);let c="nodejs",p="force-dynamic";async function u(e){let t=e.nextUrl.searchParams.get("key"),a=e.headers.get("authorization"),r=t===process.env.RUNNER_SECRET,i=process.env.CRON_SECRET&&a===`Bearer ${process.env.CRON_SECRET}`;if(!r&&!i)return o.Z.json({error:"Unauthorized"},{status:401});try{let e=await (0,d.processBroadcasts)();return o.Z.json(e)}catch(e){return o.Z.json({error:e.message},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/broadcast/runner/route",pathname:"/api/broadcast/runner",filename:"route",bundlePath:"app/api/broadcast/runner/route"},resolvedPagePath:"C:\\Users\\jeang\\OneDrive\\Desktop\\adnext\\apps\\web\\src\\app\\api\\broadcast\\runner\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:w,headerHooks:h,staticGenerationBailout:f}=g,E="/api/broadcast/runner/route";function I(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}},38375:(e,t,a)=>{a.d(t,{processBroadcasts:()=>s});var r=a(38588),i=a(59609);async function s(){let e=new Date,t=await r._.broadcastCampaign.findMany({where:{OR:[{status:"SCHEDULED",scheduledAt:{lte:e}},{status:"SENDING"}]},take:5,include:{page:!0}});if(0===t.length)return{processed:0,status:"idle"};let a=0;for(let n of t)try{if("SCHEDULED"===n.status){console.log(`[Runner] Generating audience for campaign ${n.id}`);let t={workspaceId:n.workspaceId,pageId:n.pageId},a=new Date(e.getFullYear(),e.getMonth(),e.getDate());"ACTIVE_24H"===n.audienceType?t.lastSeenAt={gte:new Date(e.getTime()-864e5)}:"ACTIVE_7D"===n.audienceType?t.lastSeenAt={gte:new Date(e.getTime()-6048e5)}:"NEW_TODAY"===n.audienceType&&(t.firstSeenAt={gte:a});let i=await r._.contact.findMany({where:t,select:{id:!0,psid:!0}});i.length>0&&await r._.broadcastRecipient.createMany({data:i.map(e=>({campaignId:n.id,workspaceId:n.workspaceId,pageId:n.pageId,userPsid:e.psid,contactId:e.id,status:"PENDING"})),skipDuplicates:!0}),await r._.broadcastCampaign.update({where:{id:n.id},data:{status:"SENDING",totalRecipients:i.length}})}let t=await r._.broadcastRecipient.findMany({where:{campaignId:n.id,status:"PENDING"},take:50});if(0===t.length){let e=await r._.broadcastRecipient.count({where:{campaignId:n.id,status:"PENDING"}});if(0===e){await r._.broadcastCampaign.update({where:{id:n.id},data:{status:"COMPLETED"}});let e=await r._.broadcastRecipient.count({where:{campaignId:n.id,status:"SENT"}}),t=await r._.broadcastRecipient.count({where:{campaignId:n.id,status:"FAILED"}}),a=await r._.broadcastRecipient.count({where:{campaignId:n.id,status:"SKIPPED"}});await r._.broadcastCampaign.update({where:{id:n.id},data:{totalSent:e,totalFailed:t,totalSkipped:a}})}continue}let o=(0,i.p)(n.page.pageAccessToken);for(let e of t){var s;let t,i=!1,d=null,c="RESPONSE",p=await r._.contact.findUnique({where:{id:e.contactId}});if(!p){await r._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:"Contact not found"}});continue}let u=(s=p.lastSeenAt,new Date().getTime()-s.getTime()<=864e5);if("24H_ONLY"===n.policyMode?u?i=!0:(i=!1,d="OUTSIDE_24H"):u?i=!0:n.tag?(i=!0,c="MESSAGE_TAG",t=n.tag):(i=!1,d="OUTSIDE_24H_NO_TAG"),!i){await r._.broadcastRecipient.update({where:{id:e.id},data:{status:"SKIPPED",skipReason:d}});continue}try{let i={recipient:{id:e.userPsid},messaging_type:c,tag:t},s=n.payload;"TEXT"===n.messageType?i.message={text:s.text}:"BUTTON_TEMPLATE"===n.messageType?i.message={attachment:{type:"template",payload:{template_type:"button",text:s.text,buttons:s.buttons}}}:"AUDIO"===n.messageType&&(i.message={attachment:{type:"audio",payload:{url:s.url}}});let d=`https://graph.facebook.com/v19.0/me/messages?access_token=${o}`,u=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),g=await u.json();u.ok?(await r._.broadcastRecipient.update({where:{id:e.id},data:{status:"SENT",sentAt:new Date,metaMessageId:g.message_id}}),await r._.messageLog.create({data:{pageId:n.pageId,contactId:p.id,campaignId:n.id,direction:"OUT",status:"SENT",actionType:"BROADCAST",rawResponse:g}}),a++):(await r._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:g.error?.message||"Unknown graph error"}}),await r._.messageLog.create({data:{pageId:n.pageId,contactId:p.id,campaignId:n.id,direction:"OUT",status:"FAILED",actionType:"BROADCAST",error:g.error?.message}}))}catch(t){await r._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:t.message}})}}let d=await r._.broadcastRecipient.count({where:{campaignId:n.id,status:"SENT"}});await r._.broadcastCampaign.update({where:{id:n.id},data:{totalSent:d}})}catch(e){console.error(`[Runner] Error processing campaign ${n.id}`,e)}return{processed:a,status:"ok"}}},59609:(e,t,a)=>{a.d(t,{H:()=>o,p:()=>d});var r=a(6113),i=a.n(r);let s="aes-256-cbc",n=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function o(e){let t=i().randomBytes(16),a=i().createCipheriv(s,Buffer.from(n),t),r=a.update(e);return r=Buffer.concat([r,a.final()]),t.toString("hex")+":"+r.toString("hex")}function d(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),r=Buffer.from(t.join(":"),"hex"),o=i().createDecipheriv(s,Buffer.from(n),a),d=o.update(r);return(d=Buffer.concat([d,o.final()])).toString()}},38588:(e,t,a)=>{a.d(t,{_:()=>i});var r=a(53524);let i=globalThis.prisma??new r.PrismaClient({log:["error","warn"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[2150,6363],()=>a(16571));module.exports=r})();