"use strict";exports.id=8375,exports.ids=[8375],exports.modules={38375:(e,t,a)=>{a.d(t,{processBroadcasts:()=>d});var i=a(38588),s=a(59609);async function d(){let e=new Date,t=await i._.broadcastCampaign.findMany({where:{OR:[{status:"SCHEDULED",scheduledAt:{lte:e}},{status:"SENDING"}]},take:5,include:{page:!0}});if(0===t.length)return{processed:0,status:"idle"};let a=0;for(let n of t)try{if("SCHEDULED"===n.status){console.log(`[Runner] Generating audience for campaign ${n.id}`);let t={workspaceId:n.workspaceId,pageId:n.pageId},a=new Date(e.getFullYear(),e.getMonth(),e.getDate());"ACTIVE_24H"===n.audienceType?t.lastSeenAt={gte:new Date(e.getTime()-864e5)}:"ACTIVE_7D"===n.audienceType?t.lastSeenAt={gte:new Date(e.getTime()-6048e5)}:"NEW_TODAY"===n.audienceType&&(t.firstSeenAt={gte:a});let s=await i._.contact.findMany({where:t,select:{id:!0,psid:!0}});s.length>0&&await i._.broadcastRecipient.createMany({data:s.map(e=>({campaignId:n.id,workspaceId:n.workspaceId,pageId:n.pageId,userPsid:e.psid,contactId:e.id,status:"PENDING"})),skipDuplicates:!0}),await i._.broadcastCampaign.update({where:{id:n.id},data:{status:"SENDING",totalRecipients:s.length}})}let t=await i._.broadcastRecipient.findMany({where:{campaignId:n.id,status:"PENDING"},take:50});if(0===t.length){let e=await i._.broadcastRecipient.count({where:{campaignId:n.id,status:"PENDING"}});if(0===e){await i._.broadcastCampaign.update({where:{id:n.id},data:{status:"COMPLETED"}});let e=await i._.broadcastRecipient.count({where:{campaignId:n.id,status:"SENT"}}),t=await i._.broadcastRecipient.count({where:{campaignId:n.id,status:"FAILED"}}),a=await i._.broadcastRecipient.count({where:{campaignId:n.id,status:"SKIPPED"}});await i._.broadcastCampaign.update({where:{id:n.id},data:{totalSent:e,totalFailed:t,totalSkipped:a}})}continue}let r=(0,s.p)(n.page.pageAccessToken);for(let e of t){var d;let t,s=!1,c=null,o="RESPONSE",p=await i._.contact.findUnique({where:{id:e.contactId}});if(!p){await i._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:"Contact not found"}});continue}let u=(d=p.lastSeenAt,new Date().getTime()-d.getTime()<=864e5);if("24H_ONLY"===n.policyMode?u?s=!0:(s=!1,c="OUTSIDE_24H"):u?s=!0:n.tag?(s=!0,o="MESSAGE_TAG",t=n.tag):(s=!1,c="OUTSIDE_24H_NO_TAG"),!s){await i._.broadcastRecipient.update({where:{id:e.id},data:{status:"SKIPPED",skipReason:c}});continue}try{let s={recipient:{id:e.userPsid},messaging_type:o,tag:t},d=n.payload;"TEXT"===n.messageType?s.message={text:d.text}:"BUTTON_TEMPLATE"===n.messageType?s.message={attachment:{type:"template",payload:{template_type:"button",text:d.text,buttons:d.buttons}}}:"AUDIO"===n.messageType&&(s.message={attachment:{type:"audio",payload:{url:d.url}}});let c=`https://graph.facebook.com/v19.0/me/messages?access_token=${r}`,u=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),g=await u.json();u.ok?(await i._.broadcastRecipient.update({where:{id:e.id},data:{status:"SENT",sentAt:new Date,metaMessageId:g.message_id}}),await i._.messageLog.create({data:{pageId:n.pageId,contactId:p.id,campaignId:n.id,direction:"OUT",status:"SENT",actionType:"BROADCAST",rawResponse:g}}),a++):(await i._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:g.error?.message||"Unknown graph error"}}),await i._.messageLog.create({data:{pageId:n.pageId,contactId:p.id,campaignId:n.id,direction:"OUT",status:"FAILED",actionType:"BROADCAST",error:g.error?.message}}))}catch(t){await i._.broadcastRecipient.update({where:{id:e.id},data:{status:"FAILED",error:t.message}})}}let c=await i._.broadcastRecipient.count({where:{campaignId:n.id,status:"SENT"}});await i._.broadcastCampaign.update({where:{id:n.id},data:{totalSent:c}})}catch(e){console.error(`[Runner] Error processing campaign ${n.id}`,e)}return{processed:a,status:"ok"}}},59609:(e,t,a)=>{a.d(t,{H:()=>r,p:()=>c});var i=a(6113),s=a.n(i);let d="aes-256-cbc",n=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function r(e){let t=s().randomBytes(16),a=s().createCipheriv(d,Buffer.from(n),t),i=a.update(e);return i=Buffer.concat([i,a.final()]),t.toString("hex")+":"+i.toString("hex")}function c(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),i=Buffer.from(t.join(":"),"hex"),r=s().createDecipheriv(d,Buffer.from(n),a),c=r.update(i);return(c=Buffer.concat([c,r.final()])).toString()}}};