"use strict";exports.id=969,exports.ids=[969],exports.modules={59609:(e,t,a)=>{a.d(t,{H:()=>n,p:()=>c});var i=a(6113),r=a.n(i);let o="aes-256-cbc",s=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function n(e){let t=r().randomBytes(16),a=r().createCipheriv(o,Buffer.from(s),t),i=a.update(e);return i=Buffer.concat([i,a.final()]),t.toString("hex")+":"+i.toString("hex")}function c(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),i=Buffer.from(t.join(":"),"hex"),n=r().createDecipheriv(o,Buffer.from(s),a),c=n.update(i);return(c=Buffer.concat([c,n.final()])).toString()}},81969:(e,t,a)=>{a.d(t,{processMessengerEvent:()=>s});var i=a(38588),r=a(59609);let o="https://graph.facebook.com/v19.0";async function s(e){if("page"===e.object)for(let t of e.entry){let e=t.id;if(t.messaging)for(let a of t.messaging)await n(e,a)}}async function n(e,t){let a=t.sender.id,r=t.message?.mid||t.postback?.mid;if(r){let t=new Date(Date.now()-12e4);if((await i._.messageLog.findMany({where:{pageId:e,direction:"IN",createdAt:{gte:t}},select:{rawEvent:!0},take:50,orderBy:{createdAt:"desc"}})).some(e=>{let t=e.rawEvent,a=t?.message?.mid,i=t?.postback?.mid;return a===r||i===r})){console.log(`[Deduplication] Skipping duplicate MID: ${r}`);return}}if(t.message?.is_echo)return;let o=await i._.messengerPage.findUnique({where:{pageId:e},include:{workspace:!0}});if(!o||!o.isActive)return;let s=await u(o,a),n="";t.message?.quick_reply?n=t.message.quick_reply.payload:t.message?.text?n=t.message.text:t.postback?.payload&&(n=t.postback.payload);let l=await i._.messageLog.create({data:{pageId:o.pageId,contactId:s.id,direction:"IN",status:"RECEIVED",incomingText:n||"[Non-text event]",rawEvent:t}});n&&await c(o,s,n,l.id)}async function c(e,t,a,r){let o=await i._.automationRule.findMany({where:{workspaceId:e.workspaceId,isActive:!0},orderBy:[{priority:"desc"},{createdAt:"asc"}],include:{actions:{orderBy:{order:"asc"}}}}),s=null;for(let r of o){let o=r.pageIds;if((!o||!(o.length>0)||o.includes(e.pageId))&&function(e,t){let a=t=>{let a=t;return e.normalizeAccents&&(a=a.normalize("NFD").replace(/[\u0300-\u036f]/g,"")),e.caseSensitive||(a=a.toLowerCase()),a.trim()},i=a(t),r=e.keywords.map(e=>a(e));return 0===r.length||("ALL"===e.matchOperator?r.every(t=>l(e.matchType,i,t)):r.some(t=>l(e.matchType,i,t)))}(r,a)){if(r.cooldownSeconds>0){let e=await i._.ruleExecution.findFirst({where:{ruleId:r.id,contactId:t.id},orderBy:{lastExecutedAt:"desc"}});if(e){let t=(new Date().getTime()-e.lastExecutedAt.getTime())/1e3;if(t<r.cooldownSeconds){console.log(`[Engine] Rule "${r.name}" matched but in cooldown (${t}s < ${r.cooldownSeconds}s)`);continue}}}s=r;break}}if(s)for(let a of(console.log(`[Engine] Matched Rule: "${s.name}" for contact ${t.psid}`),await i._.messageLog.update({where:{id:r},data:{status:"MATCHED",matchedRuleId:s.id}}),await i._.ruleExecution.create({data:{ruleId:s.id,contactId:t.id,pageId:e.pageId,timesExecuted:1}}),s.actions)){a.delayMs>0&&await new Promise(e=>setTimeout(e,a.delayMs));try{await d(e,t,a,r)}catch(e){console.error("[Engine] Action Failed:",e)}}else console.log(`[Engine] No match for text: "${a}"`),await i._.messageLog.update({where:{id:r},data:{status:"SKIPPED"}})}function l(e,t,a){switch(e){case"EXACT":return t===a;case"STARTS_WITH":return t.startsWith(a);case"REGEX":try{return RegExp(a,"i").test(t)}catch(e){return!1}default:return t.includes(a)}}async function d(e,t,a,i){let r=a.payload,o={recipient:{id:t.psid}},s=a.type;switch(a.type){case"TEXT":o.message={text:r.text};break;case"BUTTON_TEMPLATE":o.message={attachment:{type:"template",payload:{template_type:"button",text:r.text,buttons:r.buttons?.map(e=>({type:e.type||"web_url",url:"web_url"===e.type?e.url:void 0,title:e.title,payload:"postback"===e.type?e.payload:void 0}))}}};break;case"GENERIC_TEMPLATE":o.message={attachment:{type:"template",payload:{template_type:"generic",elements:[{title:r.title,subtitle:r.subtitle,image_url:r.imageUrl,buttons:r.buttons?.map(e=>({type:e.type||"web_url",url:"web_url"===e.type?e.url:void 0,title:e.title,payload:"postback"===e.type?e.payload:void 0}))}]}}};break;case"IMAGE":case"AUDIO":case"FILE":o.message={attachment:{type:a.type.toLowerCase(),payload:{url:r.url,is_reusable:!0}}};break;case"QUICK_REPLIES":o.message={text:r.text,quick_replies:r.replies?.map(e=>({content_type:"text",title:e.title,payload:e.payload||e.title}))};break;default:console.warn("Unknown action type",a.type);return}await p(e,t,o,i,s)}async function p(e,t,a,s,n){let c=(0,r.p)(e.pageAccessToken),l=`${o}/me/messages?access_token=${c}`,d=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),p=await d.json(),u=d.ok&&!p.error;if(await i._.messageLog.create({data:{pageId:e.pageId,contactId:t.id,direction:"OUT",status:u?"SENT":"FAILED",actionType:n,error:u?null:JSON.stringify(p.error),rawResponse:p,matchedRuleId:void 0}}),!u)throw Error(JSON.stringify(p.error))}async function u(e,t){let a=await i._.contact.findUnique({where:{pageId_psid:{pageId:e.pageId,psid:t}}});if(a)return i._.contact.update({where:{id:a.id},data:{lastSeenAt:new Date}});let s={};try{let a=(0,r.p)(e.pageAccessToken),i=`${o}/${t}?fields=first_name,last_name,profile_pic&access_token=${a}`,n=await fetch(i);n.ok&&(s=await n.json())}catch(e){console.error("Failed to fetch profile",e)}return i._.contact.create({data:{workspaceId:e.workspaceId,pageId:e.pageId,psid:t,firstName:s.first_name||"Unknown",lastName:s.last_name||"",profilePicUrl:s.profile_pic||"",lastSeenAt:new Date}})}},38588:(e,t,a)=>{a.d(t,{_:()=>r});var i=a(53524);let r=globalThis.prisma??new i.PrismaClient({log:["error","warn"]})}};