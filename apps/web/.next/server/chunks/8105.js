"use strict";exports.id=8105,exports.ids=[8105,6076],exports.modules={59609:(e,t,a)=>{a.d(t,{H:()=>s,p:()=>d});var n=a(6113),i=a.n(n);let o="aes-256-cbc",r=process.env.APP_ENCRYPTION_KEY||"12345678901234567890123456789012";function s(e){let t=i().randomBytes(16),a=i().createCipheriv(o,Buffer.from(r),t),n=a.update(e);return n=Buffer.concat([n,a.final()]),t.toString("hex")+":"+n.toString("hex")}function d(e){let t=e.split(":"),a=Buffer.from(t.shift(),"hex"),n=Buffer.from(t.join(":"),"hex"),s=i().createDecipheriv(o,Buffer.from(r),a),d=s.update(n);return(d=Buffer.concat([d,s.final()])).toString()}},58105:(e,t,a)=>{a.d(t,{q:()=>h,processMessengerEvent:()=>u});var n=a(38588),i=a(59609),o=a(76076),r=a(6005);let s={randomUUID:r.randomUUID},d=new Uint8Array(256),l=d.length,c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));let p="https://graph.facebook.com/v19.0";async function u(e){if("page"===e.object)for(let t of e.entry){let e=t.id;if(t.messaging)for(let a of t.messaging)await g(e,a);if(t.changes)for(let a of t.changes)"feed"===a.field&&await f(e,a.value)}}async function g(e,t){let a=t.sender.id,i=t.message?.mid||t.postback?.mid;if(i){let t=new Date(Date.now()-12e4);if((await n._.messageLog.findMany({where:{pageId:e,direction:"IN",createdAt:{gte:t}},select:{rawEvent:!0},take:50,orderBy:{createdAt:"desc"}})).some(e=>{let t=e.rawEvent,a=t?.message?.mid,n=t?.postback?.mid;return a===i||n===i}))return}if(t.message?.is_echo)return;let o=await n._.messengerPage.findUnique({where:{pageId:e},include:{workspace:!0}});if(!o||!o.isActive)return;let r=await v(o,a),s=await m(o.pageId,a),d=function(e,t=24){return!!e.lastUserMessageAt&&(new Date().getTime()-new Date(e.lastInteractionAt).getTime())/36e5>t}(s),l="",c="unknown";t.message?.quick_reply?(l=t.message.quick_reply.payload,c="postback"):t.message?.text?(l=t.message.text,c="text"):t.postback?.payload?(l=t.postback.payload,c="postback"):t.message?.attachments&&(c="attachment",l="[Attachment]"),await n._.messageEvent.create({data:{pageId:o.pageId,psid:a,direction:"IN",source:"webhook_message",messageType:c,payloadJson:t}});let p=await n._.messageLog.create({data:{pageId:o.pageId,contactId:r.id,direction:"IN",status:"RECEIVED",incomingText:l||`[${c}]`,rawEvent:t}});await n._.conversation.update({where:{id:s.id},data:{lastUserMessageAt:new Date,lastInteractionAt:new Date}}),l&&await w(o,r,l,p.id,d?"MESSAGE_OUTSIDE_24H":"MESSAGE_ANY",d)}async function f(e,t){if("comment"!==t.item||"add"!==t.verb)return;let a=await n._.messengerPage.findUnique({where:{pageId:e},include:{workspace:!0}});if(!a||!a.isActive)return;let i=t.from?.id,o=t.message,r=t.post_id,s=t.comment_id;if(i!==e){try{n._.commentEvent&&await n._.commentEvent.create({data:{pageId:a.pageId,postId:r,commentId:s,fromUserId:i,message:o,payloadJson:t}})}catch(e){console.error("Failed to log comment event (Prisma model missing?)",e)}await y(a,{message:o,post_id:r,comment_id:s,from:{id:i}})}}async function m(e,t){try{if(!n._.conversation)return{lastUserMessageAt:new Date(0),lastInteractionAt:new Date(0)};let a=await n._.conversation.findUnique({where:{pageId_psid:{pageId:e,psid:t}}});if(a)return a;return n._.conversation.create({data:{pageId:e,psid:t,lastInteractionAt:new Date}})}catch(e){return console.warn("Conversation tracking failed",e),{lastUserMessageAt:new Date(0),lastInteractionAt:new Date(0)}}}async function w(e,t,a,i,o="MESSAGE_ANY",r=!1){if(a.startsWith("FLOW_JUMP::")){let o=a.split("::")[1];console.log(`[Engine] FLOW_JUMP detected to: ${o}`);let r=await n._.automationRule.findFirst({where:{workspaceId:e.workspaceId,isActive:!0,OR:[{id:o},{name:o}]},include:{actions:{orderBy:{order:"asc"}}}});if(r){await E(r,e,t,i,a);return}console.warn(`[Engine] FLOW_JUMP failed: Rule '${o}' not found or inactive.`)}let s=["MESSAGE_ANY"];if(r&&s.push("MESSAGE_OUTSIDE_24H"),!r)try{let o=await n._.conversationState.findUnique({where:{pageId_senderPsid:{pageId:e.pageId,senderPsid:t.psid}}});if(o){if(o.expiresAt<new Date)console.log(`[Flow] State expired for ${t.psid}`),await n._.conversationState.delete({where:{id:o.id}});else{console.log(`[Flow] Processing step ${o.stepId} for ${t.psid}`),await b(o,e,t,a,i);return}}}catch(e){console.error("[Flow] State Check Error",e)}let d=(await n._.automationRule.findMany({where:{workspaceId:e.workspaceId,isActive:!0},orderBy:[{priority:"desc"},{createdAt:"asc"}],include:{actions:{orderBy:{order:"asc"}}}})).filter(e=>s.includes(e.triggerType||"MESSAGE_ANY")),l=null;for(let t of d){let a=t.pageIds;if((!a||!(a.length>0)||a.includes(e.pageId))&&t.pageId&&t.pageId!==e.pageId)continue}let c=d.filter(e=>"MESSAGE_OUTSIDE_24H"===e.triggerType),p=d.filter(e=>"MESSAGE_ANY"===e.triggerType);if(r)for(let t of c){if(!I(t,e.pageId))continue;let n=t.triggerConfig;if(n?.onlyIfReturning,x(t,a)){l=t;break}}if(!l){for(let n of p)if(I(n,e.pageId)&&x(n,a)){if(await _(n,t))continue;l=n;break}}l?await E(l,e,t,i,a):await n._.messageLog.update({where:{id:i},data:{status:"SKIPPED"}})}async function y(e,t){let a=t.message||"";if(!a)return;let i=(await n._.automationRule.findMany({where:{workspaceId:e.workspaceId,isActive:!0},orderBy:{priority:"desc"},include:{actions:!0}})).filter(e=>"COMMENT_ON_POST"===e.triggerType),o=null;for(let n of i){if(!I(n,e.pageId))continue;let i=n.triggerConfig;if(i?.postIds&&Array.isArray(i.postIds)&&i.postIds.length>0){let e=t.post_id;if(!i.postIds.some(t=>e.endsWith(t)))continue}if(x(n,a)){o=n;break}}if(o){console.log(`[Engine] Comment Rule "${o.name}" matched for post ${t.post_id}`);let i=t.from.id,r=await v(e,i);console.log(`[Engine] Rule matched: ${o.name}. Creating outgoing log for PSID: ${i}`);let s=await n._.messageLog.create({data:{pageId:e.pageId,contactId:r.id,direction:"OUT",actionType:"text",matchedRuleId:o.id,status:"PENDING"}});try{n._.messageEvent&&await n._.messageEvent.create({data:{pageId:e.pageId,psid:i,direction:"OUT",source:"comment_dm",messageType:"text",ruleId:o.id,payloadJson:{text:a,action:"reply_to_comment",comment_id:t.comment_id}}})}catch(e){console.warn("Failed to create MessageEvent OUT",e)}console.log(`[Engine] Executing actions for rule ${o.id}, replyToCommentId: ${t.comment_id}`),await E(o,e,r,s.id,a,t.comment_id)}else console.log(`[Engine] No matching comment rule found for post ${t.post_id}`)}function I(e,t){let a=e.pageIds;return(!a||!(a.length>0)||!!a.includes(t))&&(!e.pageId||e.pageId===t)}async function _(e,t){if(e.cooldownSeconds<=0)return!1;let a=await n._.ruleExecution.findFirst({where:{ruleId:e.id,contactId:t.id},orderBy:{lastExecutedAt:"desc"}});return!!a&&(new Date().getTime()-a.lastExecutedAt.getTime())/1e3<e.cooldownSeconds}async function h(e,t,a,n,i,r,s){let d=e.actions||[];console.log(`[Engine] Executing run ${i} starting at ${n}/${d.length}`);for(let l=n;l<d.length;l++){let n=d[l];if(n.delayMs>0)return console.log(`[Engine] Paused run ${i} at action ${l} for ${n.delayMs}ms`),await (0,o.o9)({executionId:i,pageId:t.pageId,psid:a.psid,ruleId:e.id,nextIndex:l+1,createdAt:Date.now(),runAt:Date.now()+n.delayMs,refLogId:r,replyToCommentId:s},n.delayMs),{status:"PAUSED"};try{let e=0===l&&!!s;await S(t,a,n,r,e?s:void 0)}catch(e){console.error(`[Engine] Action ${l} failed in run ${i}`,e)}}return console.log(`[Engine] Run ${i} completed.`),await (0,o.mO)(i),{status:"DONE"}}async function E(e,t,a,i,o,p){var u,g;if(await n._.ruleExecution.create({data:{ruleId:e.id,contactId:a.id,pageId:t.pageId,timesExecuted:1}}),e.flow&&e.flow.enabled)try{let o=e.flow;if(o.steps&&o.steps.length>0){let r=o.steps[0];console.log(`[Flow] Starting flow ${e.name}, step ${r.id}`),await n._.conversationState.upsert({where:{pageId_senderPsid:{pageId:t.pageId,senderPsid:a.psid}},create:{pageId:t.pageId,senderPsid:a.psid,ruleId:e.id,stepId:r.id,status:"waiting_input",expectedType:r.expectedType||"any",expiresAt:new Date(Date.now()+1e3*(r.expirationSeconds||300))},update:{ruleId:e.id,stepId:r.id,status:"waiting_input",expiresAt:new Date(Date.now()+1e3*(r.expirationSeconds||300))}}),await S(t,a,{type:"TEXT",payload:{text:r.message}},i);return}}catch(e){console.error("[Flow] Failed to start flow",e)}let f=!s.randomUUID||g||u?function(e,t,a){let n=(e=e||{}).random??e.rng?.()??(l>d.length-16&&((0,r.randomFillSync)(d),l=0),d.slice(l,l+=16));if(n.length<16)throw Error("Random bytes length must be >= 16");if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){if((a=a||0)<0||a+16>t.length)throw RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[a+e]=n[e];return t}return function(e,t=0){return(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase()}(n)}(u,g,void 0):s.randomUUID();try{await h(e,t,a,0,f,i,p)}catch(e){console.error(`[Engine] Failed to start run ${f}`,e)}}function x(e,t){let a=t=>{let a=t;return e.normalizeAccents&&(a=a.normalize("NFD").replace(/[\u0300-\u036f]/g,"")),e.caseSensitive||(a=a.toLowerCase()),a.trim()},n=a(t),i=e.keywords.map(e=>a(e));return 0===i.length||("ALL"===e.matchOperator?i.every(t=>T(e.matchType,n,t)):i.some(t=>T(e.matchType,n,t)))}function T(e,t,a){switch(e){case"EXACT":return t===a;case"STARTS_WITH":return t.startsWith(a);case"REGEX":try{return RegExp(a,"i").test(t)}catch(e){return!1}default:return t.includes(a)}}async function S(e,t,a,n,i){let o=a.payload;parseInt(t.psid)>0&&t.psid;let r={recipient:i?{comment_id:i}:{id:t.psid}},s=!!i,d=a.type;switch(a.type){case"TEXT":r.message={text:o.text};break;case"MESSAGE_WITH_BUTTONS":case"BUTTON_TEMPLATE":let l=o.buttons&&Array.isArray(o.buttons)&&o.buttons.length>0,c=o.text||o.message||"";if(s||!l){let e=c;if(l&&s){let t=o.buttons.map(e=>`[${e.title||e.label}]`).join(" ");e+=`

${t}`}r.message={text:e}}else r.message={attachment:{type:"template",payload:{template_type:"button",text:c,buttons:o.buttons.map(e=>{let t;let a="url"===e.actionType,n="reply"===e.actionType||"flow_jump"===e.actionType,i=a?"web_url":n?"postback":e.type||"web_url";return t="flow_jump"===e.actionType?`FLOW_JUMP::${e.value}`:"reply"===e.actionType?e.value:e.payload,{type:i,url:"web_url"===i?e.url||e.value:void 0,title:e.label||e.title,payload:t}})}}};break;case"GENERIC_TEMPLATE":if(s){let e=o.buttons?.map(e=>`[${e.title}] ${"web_url"===e.type?e.url:""}`).join("\n");r.message={text:`${o.title}
${o.subtitle||""}
${o.imageUrl||""}

${e}`}}else r.message={attachment:{type:"template",payload:{template_type:"generic",elements:[{title:o.title,subtitle:o.subtitle,image_url:o.imageUrl,buttons:o.buttons?.map(e=>({type:e.type||"web_url",url:"web_url"===e.type?e.url:void 0,title:e.title,payload:"postback"===e.type?e.payload:void 0}))}]}}};break;case"IMAGE":case"AUDIO":case"FILE":r.message={attachment:{type:a.type.toLowerCase(),payload:{url:o.url,is_reusable:!0}}};break;case"QUICK_REPLIES":i?(console.warn("[Send] Quick Replies not supported for Comment Reply. sending text only."),r.message={text:o.text}):r.message={text:o.text,quick_replies:o.replies?.map(e=>({content_type:"text",title:e.title,payload:e.payload||e.title}))};break;default:console.warn("Unknown action type",a.type);return}await A(e,t,r,n,d)}async function A(e,t,a,o,r){let s=(0,i.p)(e.pageAccessToken),d=`${p}/me/messages?access_token=${s}`,l=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),c=await l.json(),u=l.ok&&!c.error;try{if(await n._.messageLog.update({where:{id:o},data:{status:u?"SENT":"FAILED",error:u?null:JSON.stringify(c.error),rawResponse:c}}),u)try{n._.messageEvent&&await n._.messageEvent.create({data:{pageId:e.pageId,psid:t.psid,direction:"OUT",source:"automation",messageType:"text",payloadJson:a,createdAt:new Date}})}catch(e){}}catch(e){}if(!u)throw Error(JSON.stringify(c.error))}async function b(e,t,a,i,o){let r=await n._.automationRule.findUnique({where:{id:e.ruleId}});if(!r||!r.flow){await n._.conversationState.delete({where:{id:e.id}});return}let s=r.flow,d=s.steps.find(t=>t.id===e.stepId);if(!d){await n._.conversationState.delete({where:{id:e.id}});return}let l=i.trim(),c=null;if("number"===e.expectedType&&isNaN(parseFloat(l.replace(",",".")))){console.log(`[Flow] Expected number, got '${l}'. Sending fallback.`),d.fallback&&await S(t,a,{type:"TEXT",payload:{text:d.fallback.message||"Por favor, digite um n\xfamero v\xe1lido."}},o);return}if(d.conditions){for(let t of d.conditions)if("number"===e.expectedType){let e=parseFloat(l.replace(",",".")),a=parseFloat(t.match.replace(",","."));if(!isNaN(e)&&!isNaN(a)&&e===a){c=t;break}}else if(l.toLowerCase()===t.match.toLowerCase()||"*"===t.match){c=t;break}}if(c){if(console.log(`[Flow] Matched condition '${c.match}' -> Next: ${c.nextStep}`),c.actions)for(let e of c.actions)await S(t,a,e,o);if(c.nextStep){let i=s.steps.find(e=>e.id===c.nextStep);i?(await n._.conversationState.update({where:{id:e.id},data:{stepId:i.id,expectedType:i.expectedType||"any",expiresAt:new Date(Date.now()+1e3*(i.expirationSeconds||300))}}),await S(t,a,{type:"TEXT",payload:{text:i.message}},o)):await n._.conversationState.delete({where:{id:e.id}})}else await n._.conversationState.delete({where:{id:e.id}})}else console.log(`[Flow] No match for '${l}'. Sending fallback.`),d.fallback&&await S(t,a,{type:"TEXT",payload:{text:d.fallback.message||"Op\xe7\xe3o inv\xe1lida."}},o)}async function v(e,t){let a=await n._.contact.findUnique({where:{pageId_psid:{pageId:e.pageId,psid:t}}});if(a)return n._.contact.update({where:{id:a.id},data:{lastSeenAt:new Date}});let o={};try{let a=(0,i.p)(e.pageAccessToken),n=`${p}/${t}?fields=first_name,last_name,profile_pic&access_token=${a}`,r=await fetch(n);r.ok&&(o=await r.json())}catch(e){console.error("Failed to fetch profile",e)}return n._.contact.create({data:{workspaceId:e.workspaceId,pageId:e.pageId,psid:t,firstName:o.first_name||"Unknown",lastName:o.last_name||"",profilePicUrl:o.profile_pic||"",lastSeenAt:new Date}})}},38588:(e,t,a)=>{a.d(t,{_:()=>i});var n=a(53524);let i=globalThis.prisma??new n.PrismaClient({log:["error","warn"]})},76076:(e,t,a)=>{a.d(t,{VQ:()=>l,getDueExecutions:()=>s,mO:()=>r,o9:()=>i,vm:()=>d,x0:()=>o});var n=a(38588);async function i(e,t){let a=new Date(Date.now()+t);await n._.scheduledExecution.upsert({where:{id:e.executionId},create:{id:e.executionId,pageId:e.pageId,psid:e.psid,ruleId:e.ruleId,nextIndex:e.nextIndex,runAt:a,status:"PENDING",refLogId:e.refLogId,replyToCommentId:e.replyToCommentId},update:{nextIndex:e.nextIndex,runAt:a,status:"PENDING",refLogId:e.refLogId,replyToCommentId:e.replyToCommentId,attempts:0,lastError:null}}),console.log(`[Scheduler] Saved execution ${e.executionId} to run at ${a.toISOString()} (delay: ${t}ms)`)}async function o(e){let t=await n._.scheduledExecution.findUnique({where:{id:e}});return t?{executionId:t.id,pageId:t.pageId,psid:t.psid,ruleId:t.ruleId,nextIndex:t.nextIndex,createdAt:t.createdAt.getTime(),runAt:t.runAt.getTime(),refLogId:t.refLogId||void 0,replyToCommentId:t.replyToCommentId||void 0}:null}async function r(e){try{await n._.scheduledExecution.update({where:{id:e},data:{status:"DONE"}})}catch(t){console.warn(`[Scheduler] clearExecution: ${e} not found or already cleared`)}}async function s(e=50){let t=new Date;return(await n._.scheduledExecution.findMany({where:{status:"PENDING",runAt:{lte:t},attempts:{lt:5}},orderBy:{runAt:"asc"},take:e,select:{id:!0}})).map(e=>e.id)}async function d(e){try{return(await n._.scheduledExecution.updateMany({where:{id:e,status:"PENDING"},data:{status:"PROCESSING",attempts:{increment:1}}})).count>0}catch{return!1}}async function l(e,t){try{await n._.scheduledExecution.update({where:{id:e},data:{status:"PENDING",lastError:t}})}catch{}}}};