"use strict";exports.id=6076,exports.ids=[6076],exports.modules={38588:(e,t,d)=>{d.d(t,{_:()=>a});var n=d(53524);let a=globalThis.prisma??new n.PrismaClient({log:["error","warn"]})},76076:(e,t,d)=>{d.d(t,{VQ:()=>s,getDueExecutions:()=>u,mO:()=>o,o9:()=>a,vm:()=>i,x0:()=>r});var n=d(38588);async function a(e,t){let d=new Date(Date.now()+t);await n._.scheduledExecution.upsert({where:{id:e.executionId},create:{id:e.executionId,pageId:e.pageId,psid:e.psid,ruleId:e.ruleId,nextIndex:e.nextIndex,runAt:d,status:"PENDING",refLogId:e.refLogId,replyToCommentId:e.replyToCommentId},update:{nextIndex:e.nextIndex,runAt:d,status:"PENDING",refLogId:e.refLogId,replyToCommentId:e.replyToCommentId,attempts:0,lastError:null}}),console.log(`[Scheduler] Saved execution ${e.executionId} to run at ${d.toISOString()} (delay: ${t}ms)`)}async function r(e){let t=await n._.scheduledExecution.findUnique({where:{id:e}});return t?{executionId:t.id,pageId:t.pageId,psid:t.psid,ruleId:t.ruleId,nextIndex:t.nextIndex,createdAt:t.createdAt.getTime(),runAt:t.runAt.getTime(),refLogId:t.refLogId||void 0,replyToCommentId:t.replyToCommentId||void 0}:null}async function o(e){try{await n._.scheduledExecution.update({where:{id:e},data:{status:"DONE"}})}catch(t){console.warn(`[Scheduler] clearExecution: ${e} not found or already cleared`)}}async function u(e=50){let t=new Date;return(await n._.scheduledExecution.findMany({where:{status:"PENDING",runAt:{lte:t},attempts:{lt:5}},orderBy:{runAt:"asc"},take:e,select:{id:!0}})).map(e=>e.id)}async function i(e){try{return(await n._.scheduledExecution.updateMany({where:{id:e,status:"PENDING"},data:{status:"PROCESSING",attempts:{increment:1}}})).count>0}catch{return!1}}async function s(e,t){try{await n._.scheduledExecution.update({where:{id:e},data:{status:"PENDING",lastError:t}})}catch{}}}};