generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ownedWorkspaces Workspace[]
  workspaces      WorkspaceMember[]
  projects        Project[]
  pages           MessengerPage[]
}

model Project {
  id        String   @id @default(uuid())
  userId    String
  name      String
  slug      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  pages     MessengerPage[]

  @@unique([userId, slug])
  @@index([userId])
}

model Workspace {
  id                String             @id @default(uuid())
  name              String
  ownerId           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  owner             User               @relation(fields: [ownerId], references: [id])
  members           WorkspaceMember[]
  
  // New Messenger Architecture
  messengerPages    MessengerPage[]

  // Workflow integration (Fix for missing relations)
  instagramAccounts InstagramAccount[]
  workflowFolders   WorkflowFolder[]
  workflows        Workflow[]
  responseTemplates ResponseTemplate[]
  contacts          Contact[]
  automationRules   AutomationRule[]
  campaigns         BroadcastCampaign[]
}

model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String
  role        String
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, userId])
}

// ---------------------------------------------------------
// MESSENGER SPECIFIC MODELS
// ---------------------------------------------------------

model MessengerPage {
  id                   String   @id @default(uuid())
  workspaceId          String
  pageId               String   @unique
  pageName             String
  pageAccessToken      String
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  workspace            Workspace @relation(fields: [workspaceId], references: [id])
  
  projectId            String?
  project              Project?  @relation(fields: [projectId], references: [id])
  
  userId               String?
  user                 User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@unique([userId, pageId])
  logs                 MessageLog[]
  contacts             Contact[]
  ruleExecutions       RuleExecution[]
  campaigns            BroadcastCampaign[]
  automationRules      AutomationRule[]
  getStartedPayload    String?
  iceBreakers          Json?
  
  // New Architecture Relations
  conversations        Conversation[]
  messageEvents        MessageEvent[]
  commentEvents        CommentEvent[]
  conversationStates   ConversationState[]
}

model Contact {
  id              String   @id @default(uuid())
  workspaceId     String
  psid            String   // Messenger User ID (Page Scoped ID)
  firstName       String?
  lastName        String?
  profilePicUrl   String?
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @default(now())
  lastMessageText String?
  tags            Json?    // ["tag1", "tag2"]
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  pageId          String?
  page            MessengerPage? @relation(fields: [pageId], references: [pageId]) 
  logs            MessageLog[]
  ruleExecutions  RuleExecution[]

  @@unique([pageId, psid])
  @@index([pageId])
  @@index([workspaceId])
}

model AutomationRule {
  id              String   @id @default(uuid())
  workspaceId     String
  name            String
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  matchType       String   // CONTAINS, EXACT, STARTS_WITH, REGEX
  keywords        String[]
  caseSensitive   Boolean  @default(false)
  normalizeAccents Boolean @default(true)
  matchOperator   String   // ANY, ALL
  cooldownSeconds Int      @default(0)
  schedule        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  actions         AutomationAction[]
  executions      RuleExecution[]
  pageIds         String[] @default([]) // Deprecated in favor of pageId
  pageId          String?
  page            MessengerPage? @relation(fields: [pageId], references: [pageId])

  // New Trigger Fields
  triggerType     String   @default("MESSAGE_ANY") // MESSAGE_ANY, MESSAGE_OUTSIDE_24H, COMMENT_ON_POST
  triggerConfig   Json?    // Stores specific config like postIds, thresholdHours, etc.
  
  // New Flow Field
  flow            Json?    // { enabled: true, steps: [...] }

  @@index([workspaceId, isActive])
  @@index([pageId, triggerType])
}

model ConversationState {
  id           String   @id @default(uuid())
  pageId       String
  senderPsid   String
  projectId    String?
  ruleId       String
  stepId       String
  status       String   // waiting_input, finished
  expectedType String   // keyword, number, any
  metadata     Json?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  page         MessengerPage @relation(fields: [pageId], references: [pageId])

  @@unique([pageId, senderPsid])
  @@index([expiresAt])
}

model AutomationAction {
  id        String   @id @default(uuid())
  ruleId    String
  type      String   // TEXT, BUTTON_TEMPLATE, QUICK_REPLIES, AUDIO, FILE, IMAGE
  payload   Json
  order     Int      @default(0)
  delayMs   Int      @default(0)
  
  rule      AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  
  @@index([ruleId, order])
}

model MessageLog {
  id            String   @id @default(uuid())
  contactId     String?
  pageId        String
  direction     String   // IN, OUT
  incomingText  String?
  matchedRuleId String?
  actionType    String?
  status        String   // RECEIVED, MATCHED, SENT, FAILED, SKIPPED, DUPLICATE
  error         String?
  rawEvent      Json?
  rawResponse   Json?
  createdAt     DateTime @default(now())

  contact       Contact? @relation(fields: [contactId], references: [id])
  page          MessengerPage @relation(fields: [pageId], references: [pageId]) 
  campaignId    String?
  campaign      BroadcastCampaign? @relation(fields: [campaignId], references: [id]) 
  
  @@index([pageId, createdAt])
  @@index([contactId])
}

model RuleExecution {
  id             String   @id @default(uuid())
  ruleId         String
  contactId      String
  pageId         String?   // For faster filtering by page
  lastExecutedAt DateTime @default(now())
  timesExecuted  Int      @default(1)

  rule           AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  contact        Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
  page           MessengerPage? @relation(fields: [pageId], references: [pageId])
  
  @@index([pageId, lastExecutedAt])
  @@index([ruleId])
}

model BroadcastCampaign {
  id              String   @id @default(uuid())
  workspaceId     String
  pageId          String
  name            String
  status          String   // DRAFT, SCHEDULED, SENDING, PAUSED, COMPLETED, FAILED
  audienceType    String   // ALL, ACTIVE_24H, ACTIVE_7D, NEW_TODAY, CUSTOM
  audienceFilter  Json?
  sendMode        String   // IMMEDIATE, SCHEDULED
  scheduledAt     DateTime?
  policyMode      String   // 24H_ONLY, TAGGED
  tag             String?  // ACCOUNT_UPDATE, POST_PURCHASE_UPDATE, CONFIRMED_EVENT_UPDATE, HUMAN_AGENT
  messageType     String   // TEXT, BUTTON_TEMPLATE, AUDIO
  payload         Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Counters (computed or cached)
  totalRecipients Int      @default(0)
  totalSent       Int      @default(0)
  totalFailed     Int      @default(0)
  totalSkipped    Int      @default(0)

  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  page            MessengerPage @relation(fields: [pageId], references: [pageId])
  recipients      BroadcastRecipient[]
  logs            MessageLog[]
  
  @@index([workspaceId, pageId, status])
  @@index([scheduledAt])
}

model BroadcastRecipient {
  id             String   @id @default(uuid())
  campaignId     String
  workspaceId    String
  pageId         String
  userPsid       String
  contactId      String?  // Optional link to Contact
  status         String   // PENDING, SENT, FAILED, SKIPPED
  skipReason     String?
  metaMessageId  String?
  error          String?
  createdAt      DateTime @default(now())
  sentAt         DateTime?

  campaign       BroadcastCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId, status])
  @@index([workspaceId, pageId, createdAt])
  @@index([userPsid])
}

// ---------------------------------------------------------
// NEW ARCHITECTURE MODELS (Triggers & events)
// ---------------------------------------------------------

model Conversation {
  id                String   @id @default(uuid())
  pageId            String
  psid              String
  lastUserMessageAt DateTime?
  lastPageMessageAt DateTime?
  lastInteractionAt DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  page              MessengerPage @relation(fields: [pageId], references: [pageId])
  
  @@unique([pageId, psid])
  @@index([pageId, lastInteractionAt])
}

model MessageEvent {
  id          String   @id @default(uuid())
  pageId      String
  psid        String
  direction   String   // IN, OUT
  source      String   // webhook_message, webhook_postback, broadcast, comment_dm, manual_test, automation
  messageType String   // text, attachment, postback, reaction, read, referral, unknown
  payloadJson Json?
  ruleId      String?
  workflowId  String?
  createdAt   DateTime @default(now())

  page        MessengerPage @relation(fields: [pageId], references: [pageId])

  @@index([pageId, direction, createdAt])
  @@index([pageId, source])
}

model CommentEvent {
  id          String   @id @default(uuid())
  pageId      String
  postId      String
  commentId   String   @unique
  fromUserId  String?
  message     String?
  payloadJson Json?
  createdAt   DateTime @default(now())

  page        MessengerPage @relation(fields: [pageId], references: [pageId])

  @@index([pageId, postId])
}

// ---------------------------------------------------------
// WORKFLOW SYSTEM MODELS (From packages/db)
// ---------------------------------------------------------

model InstagramAccount {
  id                   String   @id @default(uuid())
  workspaceId          String
  workspace            Workspace @relation(fields: [workspaceId], references: [id])
  igUserId             String
  username             String
  profilePicUrl        String?
  status               String   // CONNECTED, DISCONNECTED, TOKEN_EXPIRED
  accessTokenEncrypted String
  tokenExpiresAt       DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  followers         InstagramFollower[]
  
  @@unique([workspaceId, igUserId])
}

model InstagramFollower {
  id              String   @id @default(uuid())
  igUserId        String   
  username        String?
  tags            String[] @default([])
  accountId       String
  account         InstagramAccount @relation(fields: [accountId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([igUserId, accountId])
}

model WorkflowFolder {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workflows   Workflow[]
}

model Workflow {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  folderId    String?
  folder      WorkflowFolder? @relation(fields: [folderId], references: [id])
  title       String
  description String?
  channels    Json     // ["dm","story","feed"]
  flowDefinition Json? // Stores the visual graph (nodes/edges) state
  isActive    Boolean  @default(false)
  status      String   // DRAFT, PUBLISHED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  runCount    Int      @default(0)
  lastRunAt   DateTime?

  triggers        WorkflowTrigger[]
  actions         WorkflowAction[]
  automationRuns  AutomationRun[]
}

model WorkflowTrigger {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  type        String   // DM_RECEIVED, STORY_REPLY, FEED_COMMENT
  configJson  Json
}

model WorkflowAction {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  type        String   // SEND_DM, REPLY_COMMENT
  configJson  Json
}

model ResponseTemplate {
  id          String   @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  name        String
  body        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WebhookEvent {
  id              String   @id @default(uuid())
  workspaceId     String?
  platform        String   // INSTAGRAM
  eventType       String
  platformEventId String   @unique // idempotency key
  payloadJson     Json
  receivedAt      DateTime @default(now())
  signatureValid  Boolean
  processedAt     DateTime?
  processingStatus String   // PENDING, PROCESSING, DONE, ERROR
  lastError       String?
  automationRuns  AutomationRun[]
}

model AutomationRun {
  id              String   @id @default(uuid())
  workflowId      String
  workflow        Workflow @relation(fields: [workflowId], references: [id])
  webhookEventId  String
  webhookEvent    WebhookEvent @relation(fields: [webhookEventId], references: [id])
  status          String   // SUCCESS, ERROR, SKIPPED
  startedAt       DateTime @default(now())
  finishedAt      DateTime?
  correlationId   String?
  errorMessage    String?
  logs            AutomationRunLog[]
}

model AutomationRunLog {
  id        String   @id @default(uuid())
  runId     String
  run       AutomationRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  ts        DateTime @default(now())
  level     String   // INFO, WARN, ERROR
  message   String
  metaJson  Json?
}
