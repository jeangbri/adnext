generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ownedWorkspaces Workspace[]
  workspaces      WorkspaceMember[]
}

model Workspace {
  id                String             @id @default(uuid())
  name              String
  ownerId           String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  owner             User               @relation(fields: [ownerId], references: [id])
  members           WorkspaceMember[]
  
  // New Messenger Architecture
  messengerPages    MessengerPage[]
  contacts          Contact[]
  automationRules   AutomationRule[]
}

model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String
  userId      String
  role        String
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, userId])
}

// ---------------------------------------------------------
// MESSENGER SPECIFIC MODELS
// ---------------------------------------------------------

model MessengerPage {
  id                   String   @id @default(uuid())
  workspaceId          String
  pageId               String   @unique
  pageName             String
  pageAccessToken      String
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  workspace            Workspace @relation(fields: [workspaceId], references: [id])
  logs                 MessageLog[]
}

model Contact {
  id              String   @id @default(uuid())
  workspaceId     String
  psid            String   // Messenger User ID (Page Scoped ID)
  firstName       String?
  lastName        String?
  profilePicUrl   String?
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @default(now())
  lastMessageText String?
  tags            Json?    // ["tag1", "tag2"]
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  logs            MessageLog[]
  ruleExecutions  RuleExecution[]

  @@unique([workspaceId, psid])
}

model AutomationRule {
  id              String   @id @default(uuid())
  workspaceId     String
  name            String
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  matchType       String   // CONTAINS, EXACT, STARTS_WITH, REGEX
  keywords        String[]
  caseSensitive   Boolean  @default(false)
  normalizeAccents Boolean @default(true)
  matchOperator   String   // ANY, ALL
  cooldownSeconds Int      @default(0)
  schedule        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace       Workspace @relation(fields: [workspaceId], references: [id])
  actions         AutomationAction[]
  executions      RuleExecution[]
}

model AutomationAction {
  id        String   @id @default(uuid())
  ruleId    String
  type      String   // TEXT, BUTTON_TEMPLATE, QUICK_REPLIES, AUDIO, FILE, IMAGE
  payload   Json
  order     Int      @default(0)
  delayMs   Int      @default(0)
  
  rule      AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
}

model MessageLog {
  id            String   @id @default(uuid())
  contactId     String?
  pageId        String
  direction     String   // IN, OUT
  incomingText  String?
  matchedRuleId String?
  actionType    String?
  status        String   // RECEIVED, MATCHED, SENT, FAILED, SKIPPED, DUPLICATE
  error         String?
  rawEvent      Json?
  rawResponse   Json?
  createdAt     DateTime @default(now())

  contact       Contact? @relation(fields: [contactId], references: [id])
  page          MessengerPage @relation(fields: [pageId], references: [pageId]) 
}

model RuleExecution {
  id             String   @id @default(uuid())
  ruleId         String
  contactId      String
  lastExecutedAt DateTime @default(now())
  timesExecuted  Int      @default(1)

  rule           AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  contact        Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
}
